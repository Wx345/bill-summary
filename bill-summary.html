<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Bill Summary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        .banner {
          height: 15vh;
          background: #2743FD;
          border-bottom-left-radius: 40px;
          border-bottom-right-radius: 40px;
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          z-index: -1;
        }
    
        body {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
          padding: 16px;
          max-width: 480px;
          margin: 0 auto;
          background: #f5f5f5;
          
        }
        h1 {
          text-align: center;
          font-size: 2rem;
          margin-bottom: 0.5rem;
          color: white;
          font-style: italic;
        }
        .card {
          border-radius: 12px;
          padding: 16px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          background: #ffffff;
          margin-top: 12px;
        }
        ul {
          padding-left: 1.2rem;
        }
        .total {
          font-weight: 600;
          margin-top: 8px;
        }
        .buttons {
          display: flex;
          gap: 12px;
          margin-top: 20px;
        }
        button {
          flex: 1;
          padding: 10px 14px;
          border-radius: 5px;
          border: none;
          font-size: 0.95rem;
          cursor: pointer;
        }
        .approve {
          background: #2743FD;
          color: white;
          
        }

        .decline {
          background: white;
          color: black;
          border: 1px solid black;
          padding: 8px 14px;      
        }
        .status {
          margin-top: 16px;
          font-weight: 500;
        }
        #payment-section {
          margin-top: 18px;
          border-top: 1px solid #e5e5e5;
          padding-top: 12px;
        }
        .payment-buttons {
          display: flex;
          flex-direction: column;
          gap: 10px;
          margin-top: 10px;
        }
        .payment-buttons button {
          flex: unset;
          width: 100%;
        }
        .pay-card {
          background: #4f46e5;
          color: #fff;
        }
        .pay-bank {
          background: #0ea5e9;
          color: #fff;
        }
        .pay-duitnow {
          background: #f97316;
          color: #fff;
        }
        small {
          color: #6b7280;
        }
        p{
            text-align: center
        }
        
        ul.items-list {
          list-style: none;
          padding: 0;
          margin: 0;
        }

        ul.items-list li {
          display: flex;
          justify-content: space-between;
          padding: 15px 0;
          border-bottom: 1px solid #f0f0f0;
          font-size: 16px;
        }

        ul.items-list li span:last-child {
          font-weight: 700;
        }


    </style>
</head>
<body>
    <div class="banner"></div>
<h1>SPLITZY</h1>
<div id="content" class="card">
    <p>Loading...</p>
</div>

<script src="https://js.stripe.com/v3"></script>

<script>
  // Read query params (name, total, items, paymentId)
  function parseQuery() {
    const params = new URLSearchParams(window.location.search);

    const name         = params.get("name") || "Unknown";    // payer
    const total        = params.get("total") || "0.00";
    const itemsRaw     = params.get("items") || "";
    const paymentId    = params.get("paymentId") || null;
    const receiverName = params.get("receiverName") || "Receiver";
    const receiverBank = params.get("receiverBank") || "No bank saved";


    const items = itemsRaw
      .split("|")
      .filter(Boolean)
      .map((part) => {
        const [itemName, price] = part.split(":");
        return { name: itemName || "", price: price || "0.00" };
      });

    return { name, total, items, paymentId };
  }

  // Parsed values
  const parsed = parseQuery();
  const name = parsed.name;
  const total = parsed.total;
  const items = parsed.items;
  const paymentId = parsed.paymentId; // ðŸ‘ˆ use this later

  function render() {
    const container = document.getElementById("content");

    const itemsHtml = items.length
      ? `<ul class="items-list">${items
          .map(
            (i) =>
              `<li><span>${i.name}</span><span>RM${Number(i.price).toFixed(
                2
              )}</span></li>`
          )
          .join("")}</ul>`
      : "<p>No items found.</p>";

    container.innerHTML = `
      <p style="font-size: 30px"><strong>Bill Summary</strong></p>
      <p style="font-size: 20px"><strong>Name:</strong></p>
      <p>${name}</p>
    
      <p style="font-size: 20px" class="total">Total Amount:</p> 
      <p style="font-size: 30px">RM${Number(total).toFixed(2)}</p>
    
      <p style="font-size: 20px"><strong>Items:</strong></p>
      ${itemsHtml}
    
      <div class="card">
        <p><strong>Paying to:</strong> ${receiverName}</p>
        <p><strong>Receiverâ€™s bank:</strong> ${receiverBank}</p>
        <small>Payment is processed via Stripe test environment.</small>
      </div>

        <!-- Step 1: Approve / Decline -->
        <div class="buttons">
          <button class="decline" id="btn-decline">Decline</button>
          <button class="approve" id="btn-approve">Approve</button>
        </div>
        <p class="status" id="status"></p>

        <!-- Step 2: Payment methods (hidden until Approve) -->
        <div id="payment-section" style="display:none;">
          <h3>Choose payment method</h3>
          <small>Powered by Stripe. Your payment is processed securely.</small>
          <div class="payment-buttons">
            <button class="pay-card" id="pay-card-btn">Pay with Card</button>
            <button class="pay-bank" id="pay-bank-btn">Pay from Bank Account</button>
            <button class="pay-duitnow" id="pay-duitnow-btn">Pay with DuitNow</button>
          </div>
          <p id="payment-status" class="status" style="margin-top:10px;"></p>
        </div>
      `;

    const statusEl = document.getElementById("status");
    const paymentSection = document.getElementById("payment-section");
    const paymentStatus = document.getElementById("payment-status");

  document.getElementById("btn-decline").onclick = async () => {
  const confirmDecline = confirm("Are you sure you want to decline this payment?");
  if (!confirmDecline) return;

  if (!paymentId) {
    alert("Missing paymentId; cannot notify app.");
    return;
  }

  try {
    await fetch("https://splitbill-backend-is66.onrender.com/api/payment-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ paymentId, status: "declined" }),
    });

    // Update UI
    document.getElementById("payment-status").textContent =
      "You declined this payment.";
    document.getElementById("btn-approve").disabled = true;
    document.getElementById("btn-decline").disabled = true;
    document.getElementById("payment-section").style.display = "none";
  } catch (e) {
    console.error("Failed to notify backend about decline", e);
    alert("Failed to notify the app. Please try again.");
  }
};



    document.getElementById("btn-approve").onclick = async () => {
  const confirmApprove = confirm("Are you sure you want to approve this payment?");
  if (!confirmApprove) return;

  if (!paymentId) {
    alert("Missing paymentId; cannot notify app.");
    return;
  }

  try {
    // Notify backend just like Decline, but with status "approved"
    await fetch("https://splitbill-backend-is66.onrender.com/api/payment-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ paymentId, status: "approved" }),
    });

    // Update UI: show payment options, disable decline
    const statusEl = document.getElementById("status");
    const paymentSection = document.getElementById("payment-section");

    statusEl.textContent = "You approved this bill. Please select a payment method below.";
    paymentSection.style.display = "block";

    document.getElementById("btn-approve").disabled = true;
    document.getElementById("btn-decline").disabled = true;
  } catch (e) {
    console.error("Failed to notify backend about approval", e);
    alert("Failed to notify the app. Please try again.");
  }
};





    // ---------- Stripe setup ----------
    const stripe = Stripe(
      "pk_test_51SUSZ32Y5rHaccD0UntYJEEk0EuXyODmKMNkPlL2D9zDEf09Itk29bDeaJt3uPfNFQTDnaDuxDcgPJwfn9AaFbvc00yZnK6uhE"
    );

    async function startPayment(method) {
      paymentStatus.textContent = "Redirecting to secure payment page...";

      try {
        const res = await fetch(
          "https://splitbill-backend-is66.onrender.com/create-checkout-session",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              total,
              payment_method: method,
              paymentId, // ðŸ‘ˆ send to backend so it can track
            }),
          }
        );

        const data = await res.json();
        if (!data.sessionId) {
          paymentStatus.textContent = "Error: Could not start payment.";
          return;
        }

        const { error } = await stripe.redirectToCheckout({
          sessionId: data.sessionId,
        });

        if (error) {
          paymentStatus.textContent =
            error.message || "Payment failed to start.";
        }
      } catch (e) {
        console.error(e);
        paymentStatus.textContent = "Network error starting payment.";
      }
    }

    // Buttons for payment methods
    document.getElementById("pay-card-btn").onclick = () => {
      startPayment("card");
    };
    document.getElementById("pay-bank-btn").onclick = () => {
      startPayment("bank");
    };
    document.getElementById("pay-duitnow-btn").onclick = () => {
      paymentStatus.textContent =
        "DuitNow integration coming soon. Please select Card or Bank for now.";
    };
  }

  render();
</script>
</body>
</html>
